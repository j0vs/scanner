<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OFFLINE SERIAL SCANNER</title>
  <style>
    /* ---------- Layout & Controls (visuals) ---------- */
    /* Radio Toggle Styling */
.runcard-toggle {
  display: flex;
  gap: 20px;
  margin: 10px 0;
}

.radio-option {
  position: relative;
  padding-left: 30px;
  cursor: pointer;
  font-size: 14px;
  color: #2c3e50;
  user-select: none;
}

.radio-option input[type="radio"] {
  position: absolute;
  opacity: 0;
  cursor: pointer;
}

.custom-radio {
  position: absolute;
  top: 2px;
  left: 0;
  height: 18px;
  width: 18px;
  background-color: #ecf0f1;
  border: 2px solid #3498db;
  border-radius: 50%;
  transition: background 0.3s;
}

.radio-option input:checked ~ .custom-radio {
  background-color: #3498db;
}

.custom-radio::after {
  content: "";
  position: absolute;
  display: none;
  top: 4px;
  left: 4px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: white;
}

.radio-option input:checked ~ .custom-radio::after {
  display: block;
}

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    h2, h3 { color: #2c3e50; margin-bottom: 10px; }
    input, select {
      padding: 10px;
      width: 100%;
      max-width: 280px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      padding: 8px 16px;
      margin: 8px 4px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background-color: #3498db;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #2980b9; }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    .left-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    }
    .saved-files { margin-top: 20px; width: 100%; }
    .saved-files ul {
      list-style: none;
      padding: 0;
      max-height: 120px;
      overflow-y: auto;
      font-size: 13px;
      color: #2c3e50;
      text-align: left;
    }

    .right-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .table-container {
      flex: 1;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
    }
    table { border-collapse: collapse; width: 100%; min-width: 600px; }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 13px;
    }
    th { background-color: #ecf0f1; position: sticky; top: 0; z-index: 2; }
    .highlight { background-color: #dff9fb; }
    .duplicate { background-color: #f8d7da; }

    .popup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #3498db;
      padding: 20px;
      z-index: 1000;
      width: 300px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      text-align: center;
    }
    .popup button {
      margin-top: 10px;
      padding: 6px 14px;
      background-color: #2ecc71;
      border-radius: 6px;
    }

    .footer { margin-top: 15px; font-size: 12px; font-style: italic; color: #7f8c8d; text-align: center; }
    #lastSaved { margin-top: 6px; font-size: 12px; color: #34495e; }
    .creator { position: absolute; bottom: 10px; right: 10px; font-size: 12px; font-style: italic; color: #95a5a6; }

    #logoutBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #e74c3c;
      padding: 6px 12px;
      border-radius: 6px;
      color: white;
      font-size: 12px;
      border: none;
      cursor: pointer;
    }
    #logoutBtn:hover { background-color: #c0392b; }

    #loginScreen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      max-width: 400px;
      margin: auto;
    }

    #appContainer { display: none; }

    @media (max-width: 900px) {
      .main-layout { grid-template-columns: 1fr; height: auto; }
      .right-panel { margin-top: 20px; }
      #logoutBtn { position: static; margin: 10px auto; display: block; }
      .creator { position: static; margin-top: 10px; display: block; }
    }
  </style>

  
</head>
<body>

<!--
  Serial Scanner UI
  - Login screen (simple password)
  - Main app (left controls, right table)
  - Saved files list + clear-history button
  - Popups for messages & confirmations
-->

<!-- Login -->
<div id="loginScreen">
  <h2>Control Login</h2>
  <input type="password" id="adminPassword" placeholder="Security Code">
  <br>
  <button onclick="adminLogin()">Enter</button>
  <p id="loginError" style="color:red; display:none;">Invalid Code</p>
</div>

<!-- Main App -->
<div id="appContainer">
  <div class="main-layout">
    <!-- Left -->
    <div class="left-panel">
      <button id="logoutBtn" onclick="logout()">Logout</button>
      <br>
      <h2>OFFLINE SCANNER</h2>
      <BR>
<label for="scannerSelect"><b>SCANNER</b></label>
<select id="scannerSelect">
  <option value="CLARISSE">CLARISSE</option>
  <option value="MIAH">MIAH</option>
  <option value="ANA">ANA MARIE</option>
  <option value="IRENE">IRENE</option>
  <option value="MARICAR">MARICAR</option>
  <option value="PEARLY">PEARLY</option>
  <option value="JOYCE">JOYCE</option>
  <option value="JENNY">JENNY</option>
  <option value="LERMA">LERMA</option>
  <option value="BHEL">BHEL</option>
  <option value="ALICE">ALICE</option>
  <option value="ANGIE">ANGIE</option>
  <option value="FHE">FHE</option>
  <option value="MHEAN">MHEAN</option>
  <option value="DHEZ">DHEZ</option>
  <option value="EDITH">EDITH</option>
  <option value="NORA">NORA</option>
</select>

<br>

<label for="inspectorInput1"><b>FVI 1</b></label>
<input type="text" id="inspectorInput1" placeholder="Type FVI 1 inspector name">
<label for="inspectorInput2"><b>FVI 2</b></label>
<input type="text" id="inspectorInput2" placeholder="Type FVI 2 inspector name">

      <BR>
      <!-- model dropdown is populated from MODELS in JS -->
      <select id="modelSelect"></select>
      <!-- serial input -->
      <input type="text" id="serialInput" placeholder="Scan barcode here" maxlength="10" disabled>      
      <BR>
      <BR>
      <label><b>RUN CARD INFORMATION</b></label>
<!-- Run Card Format Selector -->
<center>
<div class="runcard-toggle">
  <label class="radio-option">
    <input type="radio" name="runcardType" value="normal" checked>
    <span class="custom-radio"></span>
    Normal Runcard
  </label>
  <label class="radio-option">
    <input type="radio" name="runcardType" value="misc">
    <span class="custom-radio"></span>
    Misc Runcard
  </label>
</div>
</center>

<center>
<!-- Normal Runcard Fields -->
<div id="normalFields">
  <input type="text" id="lineCode" placeholder="Line Code (2 chars)" maxlength="2">
  <input type="text" id="monthDate" placeholder="Month and Date (MMDD)" maxlength="4">
  <input type="text" id="lotNumber" placeholder="Lot Number (3 digits)" maxlength="3">
</div>

<!-- Misc Runcard Fields -->
<div id="miscFields" style="display:none;">
  <input type="text" id="miscYear" placeholder="Year (YY)" maxlength="2">
  <input type="text" id="miscMonthDate" placeholder="Month and Date (MMDD)" maxlength="4">
  <input type="text" id="miscLineCode" placeholder="Line Code (2 chars)" maxlength="2">
  <input type="number" id="reworkCode" placeholder="Rework Code (1-5)" min="1" max="5">
</div>


      <!-- actions -->
      <button onclick="saveFiles()">Save Files</button>
      <button onclick="confirmNewSublot()">New Sublot</button>

      <!-- Saved files + clear history -->
      <center>
        <div class="saved-files">
          <h3>üìÅ Saved Files</h3>
          <!-- Clear History button - visually consistent with the app -->
          <button onclick="clearHistory()">Clear History</button>
          <ul id="savedHistory"></ul>
        </div>
      

      <div class="footer" id="footerNote"></div>
      <div class="creator">Created by j.mallapre</div>
    </div>

    <!-- Right -->
    <div class="right-panel">
      <div class="table-container">
        <table id="serialTable">
          <thead>
            <tr>
              <th>Number</th><th>Serial</th><th>Scanner</th><th>FVI 1</th><th>FVI 2</th><th>Timestamp</th><th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Popups -->
<div class="popup" id="popup">
  <p id="popupMessage"></p>
  <button onclick="closePopup()">OK</button>
</div>
<div class="popup" id="confirmPopup">
  <p>Are you sure you want to clear all serials?</p>
  <button onclick="newSublot()">Yes</button>
  <button onclick="closeConfirmPopup()">No</button>
</div>
</center>

<script>
/* ===========================
   Configuration & State
   ===========================
   - version: UI label
   - MAX_ROWS: safety cap for serials
   - ADMIN_PASSWORD: plain-text admin password (keep offline in production)
   - savedFiles: array of saved filenames (persisted into localStorage)
   - serials: in-memory array of serial objects for the active sublot
*/
const version = "OFFLINE SERIAL SCANNER FINAL VER 3";
const MAX_ROWS = 200;
const ADMIN_PASSWORD = "PE101";

let savedFiles = [];
let serials = [];

/* ===========================
   Models list (single source)
   - Maintain all model strings here.
   - loadModels() will render this into <select id="modelSelect"> on login.
*/
const MODELS = [
"FKP4J0 G02",
"FKP4J0 G03",
"FKT4J0 G04",
"FKP4F3 G02",
"FKP4F3 G03",
"FKT390 G01",
"FKT3G3 G03",
"FKT3H5 G04",
"FKT3H5 G06",
"FKT3W1 G01",
"FKT3W1 G02",
"FKT3M3 G02",
"FKT3M3 G03",
"FKT3U3 G01 ",
"FKT3U3 G02 ",
"FKT3U3 G03",
"FKT3Y3 G01 ",
"FKT3Y3 G02",
"FKT3Z4 G01 ",
"FKT3Z6 G01 ",
"FKT3Z6 G02",
"FKT3X1 G01 ",
"FKT3X2 G01 ",
"FKT3X3 G01",
"FKT3L2 G01 ",
"FKT3L2 G02",
"FKT3E4 G01",
"FKP4F3 G02 M",
"FKP4F3 G02 N",
"FKP4H0 G02 ",
"FKP4G0 G02",
"FKT422 G01 ",
"FKT422 G02",
"FKV2RG G01 ",
"FKV2RG G02",
"FKV2RF G01 ",
"FKV2RF G02",
"FKV2V5 G01",
"FKV392 G01 N",
"FKV392 G01 M",
"FKV392 G02 N",
"FKV392 G02 M",
"FKV3A2 G01 ",
"FKV3A2 G02",
"FKV381 G01 ",
"FKV381 G02"
];

const MODEL_VALIDATION_CODES = {
"FKP4J0 G02": "BB",
"FKP4J0 G03": "DA",
"FKT4J0 G04": ";(",
"FKP4F3 G02": "AB",
"FKP4F3 G03": "CA",
"FKT390 G01": ";(",
"FKT3G3 G03": "LA",
"FKT3H5 G04": ";(",
"FKT3H5 G06": "EA",
"FKT3W1 G01": ";(",
"FKT3W1 G02": "FB",
"FKT3M3 G02": "CC",
"FKT3M3 G03": "C3",
"FKT3U3 G01 ": ";(",
"FKT3U3 G02 ": "AJ",
"FKT3U3 G03": ";(",
"FKT3Y3 G01 ": ";(",
"FKT3Y3 G02": ";(",
"FKT3Z4 G01 ": ";(",
"FKT3Z6 G01 ": "0B",
"FKT3Z6 G02": "1B",
"FKT3X1 G01 ": ";(",
"FKT3X2 G01 ": ";(",
"FKT3X3 G01": "1C",
"FKT3L2 G01 ": "C4",
"FKT3L2 G02": "DB",
"FKT3E4 G01": ";(",
"FKP4F3 G02 M": "AB",
"FKP4F3 G02 N": "AC",
"FKP4H0 G02 ": "DA",
"FKP4G0 G02": "CA",
"FKT422 G01 ": ";(",
"FKT422 G02": "B2",
"FKV2RG G01 ": "JN",
"FKV2RG G02": "KN",
"FKV2RF G01 ": "PN",
"FKV2RF G02": "JP",
"FKV2V5 G01": "4N",
"FKV392 G01 N": "6A",
"FKV392 G01 M": "60",
"FKV392 G02 N": "7A",
"FKV392 G02 M": "70",
"FKV3A2 G01 ": "2A",
"FKV3A2 G02": "DA",
"FKV381 G01 ": "10",
"FKV381 G02": "G0"
};


/* ===========================
   Helper: loadModels()
   - Populate the model <select> using the MODELS array.
   - Called once on successful login to keep HTML small and centralized.
*/
function loadModels() {
  const modelSelect = document.getElementById("modelSelect");
  // default placeholder option
  modelSelect.innerHTML = `<option value="">Select Model</option>`;
  MODELS.forEach(model => {
    const opt = document.createElement("option");
    opt.value = model;
    opt.textContent = model;
    modelSelect.appendChild(opt);
  });
}

// Toggle run card format fields
document.querySelectorAll('input[name="runcardType"]').forEach(radio => {
  radio.addEventListener('change', function() {
    const isNormal = this.value === 'normal';
    document.getElementById('normalFields').style.display = isNormal ? 'block' : 'none';
    document.getElementById('miscFields').style.display = isNormal ? 'none' : 'block';
  });
});


/* ===========================
   Utility: getTimestamp()
   - returns a locale-formatted string for CSV and UI.
*/
function getTimestamp() {
  return new Date().toLocaleString();
}

/* ===========================
   POPUP helpers
   - showPopup(msg): show message box (OK button closes)
   - closePopup(): hide popup and re-focus main serial input
*/
function showPopup(message) {
  document.getElementById('popupMessage').innerText = message;
  document.getElementById('popup').style.display = 'block';
}
function closePopup() {
  document.getElementById('popup').style.display = 'none';
  document.getElementById('serialInput').focus();
}

/* ===========================
   SUBLOT CONTROL
   - confirmNewSublot(): show confirmation popup only if there are serials
   - closeConfirmPopup(): hides confirm dialog and restores focus
   - newSublot(): clears serials and resets text-placeholders only
*/
/**
 * confirmNewSublot
 * - If there are serials in-memory, open the confirmation modal.
 * - Otherwise show a friendly popup that there's nothing to clear.
 */
function confirmNewSublot() {
  if (serials.length === 0) { showPopup("No data to clear."); return; }
  document.getElementById('confirmPopup').style.display = 'block';
}

/**
 * closeConfirmPopup
 * - Hide the confirmation popup and focus serial input
 */
function closeConfirmPopup() {
  document.getElementById('confirmPopup').style.display = 'none';
  document.getElementById('serialInput').focus();
}

/**
 * newSublot
 * - Clears in-memory serials array and redraws table.
 * - Clears only textual placeholders (serial input + metadata fields).
 * - Does NOT forcibly change model or inspector selection (keeps user's context).
 * - Shows success popup when completed.
 */
function newSublot() {
  serials = [];            // wipe current serial buffer
  updateTable();           // redraw empty table

  // Clear text fields (placeholders reset)
 document.getElementById("serialInput").value = "";
 document.getElementById("lineCode").value = "";
 document.getElementById("monthDate").value = "";
 document.getElementById("lotNumber").value = "";
 document.getElementById("modelSelect").value = "";
 document.getElementById("inspectorInput1").value = "";
 document.getElementById("inspectorInput2").value = "";
document.getElementById("scannerSelect").value = "";
document.getElementById("lineCode").value = "";
document.getElementById("monthDate").value = "";
document.getElementById("lotNumber").value = "";

document.getElementById("miscYear").value = "";
document.getElementById("miscMonthDate").value = "";
document.getElementById("miscLineCode").value = "";
document.getElementById("reworkCode").value = "";
  // NOTE: we intentionally do NOT change operatorSelect so the user retains context

  closeConfirmPopup();
  showPopup("Sublot cleared successfully.");
}
/* ===========================
   SERIAL HANDLING
   - Listens for serialInput reaching length 10 (barcode scanner behavior)
   - addSerial(serial): push into serials[] with inspector and timestamp
   - updateTable(): redraw HTML table from serials[] (newest first)
   - removeSerial(index): remove entry by index and refresh table
   - hasDuplicates(): boolean check used before saving
*/

/**
 * serial input listener
 * - When the input field reaches 10 characters, treat it as a complete scan.
 * - Clears the input after adding.
 */
document.getElementById("serialInput").addEventListener("input", function() {
  const serial = this.value.trim();
  const selectedModel = document.getElementById("modelSelect").value;

  if (!selectedModel) {
    showPopup("Please select a model before scanning.");
    this.value = "";
    return;
  }

  if (serial.length === 10) {
    validateSerial(serial, selectedModel);
    this.value = "";
  }
});


/**
 * addSerial
 * @param {string} serial - scanned serial string (expected length 10)
 * Adds the scan at the top (unshift) to show newest first.
 */
function validateSerial(serial, model) {
  const expectedCode = MODEL_VALIDATION_CODES[model];
  const actualCode = serial.substring(2, 4); // 3rd and 4th characters

  if (expectedCode && actualCode !== expectedCode) {
    showPopup(`MODEL ERROR: Serial must contain '${expectedCode}' at positions 3 & 4 for ${model}.`);
    return;
  }

  addSerial(serial);
}


function addSerial(serial) {
  if (serials.length >= MAX_ROWS) {
    showPopup(`Row limit reached.`);
    return;
  }

  const scanner = document.getElementById("scannerSelect").value;
  const inspector1 = document.getElementById("inspectorInput1").value.trim();
  const inspector2 = document.getElementById("inspectorInput2").value.trim();

  if (!inspector1) {
    showPopup("Please enter FVI 1 name.");
    return;
  }

    if (!inspector2) {
    showPopup("Please enter FVI 2 name.");
    return;
  }

  serials.unshift({ serial, scanner, inspector1, inspector2, timestamp: getTimestamp() });
  updateTable();
}


document.getElementById("modelSelect").addEventListener("change", function() {
  const serialInput = document.getElementById("serialInput");
  serialInput.disabled = !this.value;
});


/**
 * updateTable
 * - Rebuilds the <tbody> from the serials[] array.
 * - Adds visual classes for newest (highlight) and duplicates (duplicate).
 * - Each row contains a Remove button which calls removeSerial(index).
 */
function updateTable() {
  const tbody = document.querySelector('#serialTable tbody');
  tbody.innerHTML = "";
  const seen = new Set();

  serials.forEach((entry, index) => {
    const row = document.createElement("tr");

    // Visual cues
    if (index === 0) row.classList.add("highlight"); // newest
    if (seen.has(entry.serial)) row.classList.add("duplicate"); // duplicate highlight
    seen.add(entry.serial);

    // Row HTML - Number column shows reversed index (newest = highest number)
row.innerHTML = `
  <td>${serials.length - index}</td>
  <td>${entry.serial}</td>
  <td>${entry.scanner}</td>
  <td>${entry.inspector1}</td>
  <td>${entry.inspector2}</td>
  <td>${entry.timestamp}</td>
  <td><button onclick="removeSerial(${index})">Remove</button></td>
`;

    tbody.appendChild(row);
  });
}

/**
 * removeSerial
 * @param {number} index - index in serials[] to remove
 * Removes the chosen serial and refreshes the table.
 */
function removeSerial(index) {
  serials.splice(index, 1);
  updateTable();
}

/**
 * hasDuplicates
 * @returns {boolean} true if any duplicate serial exists in serials[]
 * Used to prevent saving when duplicates are present.
 */
function hasDuplicates() {
  const s = serials.map(e => e.serial);
  return new Set(s).size !== s.length;
}

/* ===========================
   FILE / CSV HANDLING
   - saveFiles(): validate inputs, build CSV content, trigger download
   - downloadFile(path, content, type): helper that creates a Blob and clicks an anchor
   - updateFooter(filename): update UI footer with last saved info
   - updateSavedHistory(name): push filename into savedFiles[] and persist to localStorage
*/

/**
 * updateFooter
 * @param {string} filename - optional filename to display as "Last saved file"
 * Updates footer with version and timestamp and (optionally) last saved file.
 */
function updateFooter(filename) {
  const footer = document.getElementById("footerNote");
  footer.innerText = `${version} | Last Saved: ${getTimestamp()}`;
  const existing = document.getElementById("lastSaved");
  if (existing) existing.remove();
  if (filename) {
    const lastSaved = document.createElement("div");
    lastSaved.id = "lastSaved";
    lastSaved.innerText = "Last saved file: " + filename;
    footer.appendChild(lastSaved);
  }
}

/**
 * saveFiles
 * - Validates model/line/date/lot and ensures there's at least one serial.
 * - Prevents saving if duplicates are detected.
 * - Constructs a standard CSV content and triggers a download.
 * - Adds the filename to savedFiles[] history and persists it.
 */
function saveFiles() {
  
  const runcardType = document.querySelector('input[name="runcardType"]:checked').value;

  if (serials.length === 0) return showPopup("No serials to save.");
  if (hasDuplicates()) return showPopup("Cannot save. Duplicate serials found.");

  let baseName = "";
  let codeString = "";

  if (runcardType === "normal") {
    const model = document.getElementById("modelSelect").value;
    const lineCode = document.getElementById("lineCode").value.trim().toUpperCase();
    const monthDate = document.getElementById("monthDate").value.trim();
    const lotNumber = document.getElementById("lotNumber").value.trim();

    if (!model) return showPopup("Please select a model.");
    if (!lineCode.match(/^[A-Z0-9]{2}$/)) return showPopup("Line Code must be 2 alphanumeric characters.");
    if (!monthDate.match(/^\d{4}$/)) return showPopup("Month and Date must be 4 digits (MMDD).");
    if (!lotNumber.match(/^\d{3}$/)) return showPopup("Lot Number must be 3 digits.");

    const now = new Date();
    const monthNames = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEPT","OCT","NOV","DEC"];
    const monthYear = `${monthNames[now.getMonth()]}${now.getFullYear()}`;
    baseName = `${model}-${monthYear}-${lineCode}-${monthDate}-${lotNumber}`;
    codeString = `${lineCode}-${monthDate}-${lotNumber}`;

  } else {
    const model = document.getElementById("modelSelect").value;
    const year = document.getElementById("miscYear").value.trim();
    const monthDate = document.getElementById("miscMonthDate").value.trim();
    const lineCode = document.getElementById("miscLineCode").value.trim().toUpperCase();
    const reworkCode = document.getElementById("reworkCode").value.trim();

    if (!model) return showPopup("Please select a model.");
    if (!year.match(/^\d{2}$/)) return showPopup("Year must be 2 digits (YY).");
    if (!monthDate.match(/^\d{4}$/)) return showPopup("Month and Date must be 4 digits (MMDD).");
    if (!lineCode.match(/^[A-Z0-9]{2}$/)) return showPopup("Line Code must be 2 alphanumeric characters.");
    if (!reworkCode.match(/^[1-5]$/)) return showPopup("Rework Code must be a number from 1 to 5.");

    baseName = `${model}-MISC-${year}-${monthDate}-${lineCode}-R${reworkCode}`;
    codeString = `${year}-${monthDate}-${lineCode}-R${reworkCode}`;

  }

  // Build CSV content
  let csvContent = `RUN CARD,${codeString}\n`;
csvContent += "Number,Serial,Scanner,FVI 1,FVI 2,Timestamp\n";
serials.forEach((entry, index) => {
  csvContent += `${serials.length - index},${entry.serial},${entry.scanner},${entry.inspector1},${entry.inspector2},${entry.timestamp}\n`;
});


  downloadFile(`${baseName}.csv`, csvContent, "text/csv");

  if (!savedFiles.includes(baseName)) {
    updateFooter(baseName);
    updateSavedHistory(baseName);
    showPopup(`Saved as ${baseName}.csv`);
  }
}


/**
 * downloadFile
 * @param {string} path - filename for download
 * @param {string} content - file body text
 * @param {string} type - MIME type (e.g. text/csv)
 * Creates a blob and programmatically clicks a link to start the download.
 */
function downloadFile(path, content, type) {
  const blob = new Blob([content], { type: type });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = path;
  a.click();
}

/**
 * updateSavedHistory
 * @param {string} name - optional filename to add to in-memory history
 * - Keeps last 10 entries in the UI (but saves all in localStorage)
 * - Persists savedFiles[] using localStorage.setItem("savedFiles", JSON.stringify(savedFiles))
 */
function updateSavedHistory(name) {
  if (name) savedFiles.unshift(name);
  localStorage.setItem("savedFiles", JSON.stringify(savedFiles));
  const historyList = document.getElementById("savedHistory");
  historyList.innerHTML = "";
  savedFiles.slice(0, 10).forEach(file => {
    const li = document.createElement("li");
    li.textContent = file;
    historyList.appendChild(li);
  });
}

/* ===========================
   Clear History
   - clearHistory(): remove savedFiles[] and localStorage key, update UI
*/
function clearHistory() {
  savedFiles = [];
  localStorage.removeItem("savedFiles"); // remove persisted history
  document.getElementById("savedHistory").innerHTML = "";
  showPopup("History cleared.");
}

/* ===========================
   Authentication (very simple)
   - adminLogin(): checks ADMIN_PASSWORD, initializes UI (loads models & history)
   - logout(): clears working state and shows login screen
*/
function adminLogin() {
  const entered = document.getElementById("adminPassword").value;
  if (entered === ADMIN_PASSWORD) {
    // show app
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("appContainer").style.display = "block";
    document.getElementById("serialInput").focus();

    // restore savedFiles (if any) and models
    savedFiles = JSON.parse(localStorage.getItem("savedFiles")) || [];
    updateSavedHistory();
    updateFooter(); // shows version + last-saved timestamp (if any)
    loadModels();   // populate model dropdown from MODELS
  } else {
    document.getElementById("loginError").style.display = "block";
  }
}

function logout() {
  serials = [];           // clear working data (keeps history)
  updateTable();          // refresh table to empty
  document.getElementById("serialInput").value = "";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("adminPassword").value = "";
  document.getElementById("loginError").style.display = "none";
}

/* ===========================
   End of script
   - All data in savedFiles is stored locally in the browser only (localStorage).
   - To export history or move it between machines, you must manually copy saved CSVs.
   - Jovs, 2025
*/
</script>
</body>
</html>
